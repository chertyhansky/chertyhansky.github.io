+++
author = "Akaky Chertyhansky"
title = 'Разборки с клавиатурой'
date = 2024-10-30T21:15:56+05:00
description = "Пишем свою раскладку клавиатуры"
tags = [
    "linux",
    "keyboard",
    "xkb",
    "xcape",
]
categories = [
    "linux",
]
+++

## Преамбула

Когда-то давно наткнулся на сборник статей под названием ["заметки на полях клавиатуры"](https://unixforum.org/viewtopic.php?t=49203). Крайне рекомендую тем, кто вдруг не читал. Впечатлившись, сначала переназначил себе переключение раскладок на нециклическое - <key>LCtrl</key> - en, <key>RCtrl</key> - ru. А сам <key>Ctrl</key> переназначил на <key>CapsLock</key>. Сейчас в дебрях xkb уже есть вариант переключения раскладок `lctrl_rctrl_toggle`, поэтому даже не нужно ничего особенно делать, просто выбрать этот вариант переключения, если вдруг остальное в раскладке клавиатуры устраивает.

Потом выяснилось, что в xkb есть third level, что позволяет на одну клавишу повесить не два символа, а 4: например, помимо `c` и `C` эта же клавиша с дополнительным модификатором (у меня это <key>RAlt</key>) будет выдавать ещё и `°` и `©`. Ну а поскольку держать это всё в куче дополнительных файлов и собирать потом эту солянку в xorg.conf - то ещё удовольствие, я решил пойти более прямым путём и написать свою раскладку.

```
 ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┲━━━━━━━━━┓
 │ ~ ~ │ ! ≈ │ @ ∞ │ # § │ $ € │ % ‰ │ ^ ≤ │ & ≥ │ * × │ ( { │ ) } │ _ – │ + ± ┃ ⌫       ┃
 │ `  ́ │ 1 ÷ │ 2 ¤ │ 3 № │ 4 $ │ 5 ° │ 6 < │ 7 > │ 8 • │ 9 [ │ 0 ] │ - — │ = ≠ ┃Backspace┃
 ┢━━━━━┷━┱───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┺━┳━━━━━━━┫
 ┃       ┃ Q   │ W   │ E   │ R ® │ T   │ Y   │ U   │ I   │ O   │ P   │ {   │ }   ┃ Enter ┃
 ┃ Tab ↹ ┃ q   │ w 3 │ e 2 │ r 1 │ t   │ y   │ u PU│ i Hm│ o En│ p   │ [   │ ]   ┃   ⏎   ┃
 ┣━━━━━━━┻┱────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┺┓      ┃
 ┃ Ctrl   ┃ A   │ S   │ D   │ F   │ G   │ H   │ J   │ K   │ L   │ :   │ "   │ |   ┃      ┃
 ┃        ┃ a   │ s 6 │ d PD│ f 4 │ g   │ h ← │ j ↓ │ k ↑ │ l → │ ;   │ '   │ \   ┃      ┃
 ┣━━━━━━━━┻━┱───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┲━━━┷━━━━━┻━━━━━━┫
 ┃          ┃ Z   │ X   │ C © │ V   │ B   │ N ™ │ M   │ < « │ > » │ ?   ┃                ┃
 ┃  Shift ⇧ ┃ z „ │ x “ │ c ° │ v   │ b   │ n ₸ │ m µ │ , „ │ . “ │ /   ┃     Shift ⇧    ┃
 ┣━━━━━━━┳━━┻━━━━┳┷━━━━━┷┱────┴─────┴─────┴─────┴─────┴─────┴┲━━━━┷━━┳━━┻━━━━┳━━━━━━━┳━━━┛
 ┃       ┃       ┃       ┃                                   ┃  LV3  ┃       ┃       ┃
 ┃ Grp1  ┃ Meta  ┃  Alt  ┃              Space                ┃AltGr ⇮┃ Menu  ┃ Grp2  ┃
 ┗━━━━━━━┻━━━━━━━┻━━━━━━━┹───────────────────────────────────┺━━━━━━━┻━━━━━━━┻━━━━━━━┛
```

```
 ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┲━━━━━━━━━┓
 │ Ё ~ │ ! ≈ │ " ∞ │ # § │ ; € │ : ‰ │ , ≤ │ . ≥ │ * × │ ( { │ ) } │ _ – │ + ± ┃ ⌫       ┃
 │ ё ' │ 1 ÷ │ 2 ¤ │ 3 № │ 4 $ │ 5 ° │ 6 < │ 7 > │ 8 • │ 9 [ │ 0 ] │ - — │ = ≠ ┃Backspace┃
 ┢━━━━━┷━┱───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┺━┳━━━━━━━┫
 ┃       ┃ Й Ұ │ Ц   │ У Ү │ К Қ │ Е Є │ Н Ң │ Г Ғ │ Ш Ї │ Щ Ө │ З   │ Х Һ │ Ъ Ї ┃ Enter ┃
 ┃ Tab ↹ ┃ й ұ │ ц   │ у ү │ к қ │ е є │ н ң │ г ғ │ ш ї │ щ ө │ з § │ х һ │ ъ ї ┃   ⏎   ┃
 ┣━━━━━━━┻┱────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┴┬────┺┓      ┃
 ┃ Ctrl   ┃ Ф   │ Ы І │ В Ў │ А Ә │ П   │ Р   │ О   │ Л   │ Д   │ Ж : │ Э " │ | ¦ ┃      ┃
 ┃        ┃ ф   │ ы і │ в ў │ а ә │ п § │ р ← │ о ↓ │ л ↑ │ д → │ ж ; │ э ' │ / \ ┃      ┃
 ┣━━━━━━━━┻━┱───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┬───┴─┲━━━┷━━━━━┻━━━━━━┫
 ┃          ┃ Я   │ Ч   │ С © │ М   │ И   │ Т ™ │ Ь ₽ │ Б « │ Ю » │ ?   ┃                ┃
 ┃  Shift ⇧ ┃ я „ │ ч “ │ с ° │ м   │ и   │ т ₸ │ ь µ │ б < │ ю > │ /   ┃     Shift ⇧    ┃
 ┣━━━━━━━┳━━┻━━━━┳┷━━━━━┷┱────┴─────┴─────┴─────┴─────┴─────┴┲━━━━┷━━┳━━┻━━━━┳━━━━━━━┳━━━┛
 ┃       ┃       ┃       ┃                                   ┃ LV3   ┃       ┃       ┃
 ┃ Grp1  ┃ Meta  ┃  Alt  ┃                Space              ┃AltGr ⇮┃ Menu  ┃ Grp2  ┃
 ┗━━━━━━━┻━━━━━━━┻━━━━━━━┹───────────────────────────────────┺━━━━━━━┻━━━━━━━┻━━━━━━━┛
```

## Пишем

Ничего сложного в этом нет. В качестве примеров можно посмотреть в `/usr/share/X11/xkb/symbols/us` или `/usr/share/X11/xkb/symbols/ru` (путь может отличаться в зависимости от дистрибутива). Но эти файлы мы трогать не будем, т.к. они перезаписываются при каждом обновлении xkb.

Мы создадим свои файлы в `/usr/share/X11/xkb/symbols/`, например, `us_my` и `ru_my`. Имя может быть любым, главное чтобы такого файла не было (и не могло появиться) в стандартном xkb.

## Формат файла

Строки, начинающиеся с `//` - комментарии.

Файл начинается с объявления раскладки:

```
default partial alphanumeric_keys
xkb_symbols "my" {
    include "us(basic)"
    include "level3(ralt_switch)"
    name[Group1]= "English (with ads)";
    ...
}
// Не забыть закрыть скобку в конце, иначе не заработает.
```

В одном файле их может быть несколько.

Здесь мы объявили раскладку `"my"`.
j
Далее две директивы include.
Первой мы прочитали секцию `"basic"` из файла `us`.
Т.е. нам уже не нужно описывать всю раскладку целиком, она сейчас совпадает с той, что описана в файле `us`, в секции `xkb_symbols "basic"`.
Мы поменяем только то, что нам нужно.

Второй include читает секцию `xkb_symbols "ralt_switch"` из файла `level3`.
Это можно было бы сделать опцией в xorg.conf, и было бы идеологически более правильно, но...
Я пишу раскладку себе, и мне проще, когда она вся написана в одном месте.

Ну и `name[Group1]` - просто удобочитаемое имя. 

А дальше...
```
    key <RALT>	{ [ ISO_Level3_Shift ]	};
    key <MENU>	{ [ Menu ]	};
```
Да, бац - и переписали то, ради чего был последний include.
У меня в файлах немного бардак, так что include можно убрать и оставить это.
Ну или убрать эту строку. Оставлю на усмотрение читателя.

Далее - объявление клавиши Menu. Тоже атавизм - на нынешней клавиатуре у меня её нет, а строчка осталась.

А дальше - первый ряд клавиатуры, цифры:
```
    key <TLDE> { [ grave,	asciitilde,		U2019,				apostrophe		] };
    key <AE01> { [ 1,		exclam,			division,			U2248			] };
    key <AE02> { [ 2,		at,				currency,			infinity		] };
    key <AE03> { [ 3,		numbersign,		numerosign,			U20B4			] };
    key <AE04> { [ 4,		dollar,			dollar,				EuroSign		] };
    key <AE05> { [ 5,		percent,		degree,				permille		] };
    key <AE06> { [ 6,		asciicircum,	less,				lessthanequal	] };
    key <AE07> { [ 7,		ampersand,		greater,			greaterthanequal ] };
    key <AE08> { [ 8,		asterisk,		enfilledcircbullet,	multiply		] };
    key <AE09> { [ 9,		parenleft,		bracketleft,		braceleft		] };
    key <AE10> { [ 0,		parenright,		bracketright,		braceright		] };
    key <AE11> { [ minus,	underscore,		emdash,				endash			] };
    key <AE12> { [ equal,	plus,			notequal,			plusminus		] };
```

Здесь каждая клавиша имеет 4 символа.
Для <key>1</key> это будет, соответственно, нажатие <key>1</key>, <key>Shift</key>+<key>1</key>, <key>RAlt</key>+<key>1</key>, <key>RAlt</key>+<key>Shift</key>+<key>1</key>.
Не буду приводить листинг всего файла, лучше прикреплю свои целиком.

[us_dclxvi](/files/us_dclxvi)

[ru_dclxvi](/files/ru_dclxvi)

## Парочка финтов ушами

Могут привлечь внимание последние строки в файле:
```
    key <SPCE> {[  space,  Escape  ], type[group1] = "PC_CONTROL_LEVEL2" };
    key <PRSC>  { [ ISO_Last_Group, Print], type[group1] = "PC_CONTROL_LEVEL2" };
```

Наверное, несложно догадаться что это, но для полной ясности поясню что это и почему оно не работает (второе мне было неочевидно по началу).

Первая описывает клавишу <key>Space</key>, она же <key>Пробел</key>.
Мне очень хотелось, чтобы <key>Ctrl</key>+<key>Space</key> в результате давало <key>Esc</key>.
Но ничего у меня не вышло, т.к. выдаёт оно не просто <key>Esc</key>, а <key>Ctrl</key>+<key>Esc</key>.

В итоге сначала нашёл решение в виде утилиты [xcape](https://github.com/alols/xcape).
Она позволяет в том числе назначить на любой модификатор клавишу <key>Esc</key>, если он просто нажат.
Таким образом у меня получилось следующее:
```sh
# эту строку добавить в ~/.xinitrc:
xcape -t 1000 -e 'Control_L=ISO_First_Group;XF86WakeUp=ISO_First_Group;Shift_L=ISO_First_Group'
```
Здесь:
- `-t` указывает длительность в мс, после которого xcape не станет обрабатывать нажатие. А дальше идёт описание клавиш:
- `Control_L=ISO_First_Group`: <key>Ctrl</key> будет переключать на первую раскладку (напомню, у меня <key>Ctrl</key> находится на <key>CapsLock</key>);
- `XF86WakeUp=Iso_First_Group`: это клавиша <key>Fn</key>, которая на ThinkPad находится на месте левого <key>Ctrl</key>;
- `Shift_L=ISO_First_Group`: ну и <key>Shift</key> пускай тоже переключает, мне не жалко.

Сначала там было `Control_L=Escape`, но это оказалось неудобно.
В итоге вернулся к изначальному варианту, но при помощи [xdotool](https://github.com/jordansissel/xdotool).
Нужно назначить на сочетание <key>Ctrl</key>+<key>Space</key> команду `sleep 0.2; xdotool key Escape`.
Я сделал через notion, добавив в `cfg_hotkeys.lua`:
```lua
defbindings("WMPlex.toplevel", {
	bdoc("Bind Ctrl+Space to Esc."),
	kpress("Control+space",     "notioncore.exec_on(_, 'sleep 0.2; xdotool key Escape')"),
	-- some other stuff
}
```
Здесь `sleep 0.2` нужен чтобы успеть отпустить <key>Ctrl</key>, иначе опять получится то же, с чего начали.
Значение подбирается такое, чтобы не сильно бесила задержка, но и при этом успевать отпустить <key>Ctrl</key>.

Ну и остальные финты вполне очевидны из файлов раскладки:
- <key>RAlt</key>+<key>hjkl</key> = курсор;
- <key>RAlt</key>+<key>i</key>/<key>o</key> = <key>Home</key>/<key>End</key>;
- <key>RAlt</key>+<key>u</key>/<key>d</key> = <key>PgUp</key>/<key>PgDn</key>.

Это всё потому что на тхинкпадовской клавиатуре вышеупомянутые клавиши расположены, я бы сказал, бестолково.
Причём это сделано только в раскладке us, т.к. в ru всё уже занято дополнительными символами, и места там под это всё нет.
Но я всё-равно переключаюсь на us при любых манипуляциях (vim надрессировал), так что это не проблема.

Вот, пожалуй, и всё.
